{% extends "base.html" %}
{% block title %}Challenges{% endblock %}
{% block head %}
<script>
    var state = !{{ solved.count() }};
    function openAll() {
        $(".collapsible-header").each(function(i, x){ $(x).hasClass("active") || $(x).click(); });
        $("#toggleState").html("Collapse all challenges.");
    }
    function closeAll() {
        $(".collapsible-header").each(function(i, x){ $(x).hasClass("active") && $(x).click(); });
        $("#toggleState").html("Expand all challenges.");
    }
    function toggle() {
        if(state) closeAll();
        else openAll();
        state = !state;
    }
    function filterCategories(t) {
        var v = t.options[t.selectedIndex].value;
        if(v == "*")
        $(".challenge").show();
        else {
            $(".challenge[data-category=" + v + "]").show();
            $(".challenge[data-category!=" + v + "]").hide();
        }
    }
</script>
{% endblock %}
{% block content %}

<select onchange="filterCategories(this);">
    <option value="*">Show all</option>
    {% for category in categories %}
    <option>{{ category }}</option>
    {% endfor %}
</select>
<span class="left"><a href="javascript:toggle()" id="toggleState">{% if solved.count() %}Expand all challenges.{% else %}Collapse all challenges.{% endif %}</a></span>
<br />
{% for stage in stages %}
<h3>{{ stage.name }}</h3>
<span class="pull-right" />
<ul class="collapsible popout" data-collapsible="expandable">
    {% for challenge in challenges[stage.id] %}
    <li class="challenge" data-category="{{ challenge.category }}" data-stage="{{stage.alias}}">
        <div id="header{{ challenge.alias }}" class="collapsible-header {% "active" if challenge not in solved else "" %}">
            <div class="status-dot green circle tooltipped" data-position="right" data-tooltip="This challenge is Online"></div>
            <div class="challenge-text truncate">{{ challenge.name }}</div>
            <span class="right">
                <span>{{ challenge.author }}</span>
                <b>&middot;</b>
                <span id="solves{{ challenge.id }}">{{ solves[challenge.id] }}</span> {% if solves[challenge.id] == 1 %}solve{% else %}solves{% endif %}
                <b>&middot;</b>
                {{ challenge.category }}
                <b>&middot;</b>
                {{ challenge.points }} pt

                {% if challenge in solved %}
                    <i id="check{{ challenge.id }}" class="material-icons green-text right check-icon">done</i>
                {% else %}
                    <div class="check-pad"></div>
                {% endif %}
            </span>
        </div>
        <div class="collapsible-body">
            <p>{{ challenge.description | safe }}
                {% if challenge in solved %}
                <br /><br /><strong>You've solved this challenge!</strong><br />
                <a href="{{ url_for('.show_solves', challenge_id=challenge.id) }}">View solves</a>
            </p>
            {% else %}
            <br /><br />
            <a href="{{ url_for('.show_solves', challenge_id=challenge.id) }}">View solves</a>
            </p>
            <form class="flag-form" action="{{ url_for('.submit', challenge_id=challenge.id) }}" data-challengeid="{{ challenge.id }}" method="POST">
                <div class="row no-bot">
                    <div class="col s12 m10">
                        <div class="input-field">
                            <input required id="flag{{ challenge.id }}" name="flag" type="text" />
                            <label for="flag{{ challenge.id }}">Flag</label>
                        </div>
                    </div>
                    <div class="col s12 m2">
                    <button class="btn waves-effect waves-light flag-submit" type="submit">Submit</button>
                    </div>
                    <input name="_csrf_token" type="hidden" value="{{ csrf_token() }}" />
                </div>
            </form><br />
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endfor %}
{% endblock %}
{% block postscript %}
<script>
    $(function() {
        $("select").material_select();
    });
</script>
{% if config.apisubmit %}
<script>
    $("form").submit(function(e) {
        var id = $(this).attr("data-challengeid");
        api.makeCall("/submit/" + id + ".json", {flag: $("#flag" + id).val(), _csrf_token: "{{ csrf_token() }}"}, function(data) {
            if(data.code) {
                Materialize.toast(data.message, 4000);
            }
            else {
                Materialize.toast("Flag accepted!", 4000);
                $("#check" + id).show();
                $("#header" + id).click();
                $("#solves" + id).html(parseInt($("#solves" + id).html()) + 1);
            }
        });
        return false;
    });
</script>
{% endif %}
{% endblock %}
